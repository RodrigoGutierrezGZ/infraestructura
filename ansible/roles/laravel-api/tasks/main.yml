---
# =========================================
# Tareas principales del role laravel-api
# Cumple con requisitos Fase 2 del PDF
# =========================================

# SETUP INICIAL - Preparación del entorno
- name: Create application user
  user:
    name: "{{ app_user }}"
    group: "{{ app_group }}"
    system: yes
    shell: /bin/bash
    home: "{{ app_directory }}"
    create_home: yes
  tags: ['setup', 'user']

- name: Install required packages
  package:
    name:
      - docker.io
      - docker-compose
      - git
      - curl
      - unzip
      - python3-pip
    state: present
  tags: ['setup', 'packages']

- name: Install Docker Compose
  pip:
    name: docker-compose
    state: present
  tags: ['setup', 'docker']

- name: Add user to docker group
  user:
    name: "{{ app_user }}"
    groups: docker
    append: yes
  tags: ['setup', 'docker']

- name: Start and enable Docker service
  systemd:
    name: docker
    state: started
    enabled: yes
  tags: ['setup', 'docker']

# 1. REQUISITO PDF: Asegurar que el directorio del proyecto existe en la VM
- name: Create project directory
  file:
    path: "{{ app_directory }}"
    state: directory
    mode: '0755'
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
  tags: ['setup', 'directories']

# 2. REQUISITO PDF: Transferencia del archivo docker-compose.yml [cite: 48]
- name: Copy docker-compose file
  template:
    src: docker-compose.yml.j2  # Template con variables de entorno
    dest: "{{ app_directory }}/docker-compose.yml"
    mode: '0644'
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
  tags: ['deploy', 'files']

# Alternativa si docker-compose.yml es archivo fijo:
# - name: Copy docker-compose file (fixed)
#   copy:
#     src: docker-compose.yml
#     dest: "{{ app_directory }}/docker-compose.yml"
#     mode: '0644'
#     owner: "{{ app_user }}"
#     group: "{{ app_group }}"

- name: Generate Laravel environment file
  template:
    src: .env.production.j2
    dest: "{{ app_directory }}/.env"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0640'
  tags: ['deploy', 'config']

# 3. REQUISITO PDF: Login al Registry (necesario si el repo es privado)
- name: Log into Docker Registry
  docker_login:
    registry_url: ghcr.io  # GitHub Container Registry
    username: "{{ lookup('env', 'DOCKER_USER') | default(ansible_user) }}"
    password: "{{ lookup('env', 'DOCKER_PASSWORD') | default(github_token) }}"
  no_log: true  # Por seguridad - no mostrar credenciales en logs
  tags: ['deploy', 'registry']
  when: docker_registry_login | default(true)

# 4. REQUISITO PDF: Descarga de la imagen del Registry [cite: 49]
- name: Pull latest Docker image
  docker_image:
    name: "{{ docker_image }}"
    source: pull
    force_source: yes
  become_user: "{{ app_user }}"
  tags: ['deploy', 'pull']

# 5. REQUISITO PDF: Ejecución del comando docker-compose up -d [cite: 51]
- name: Start application with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ app_directory }}"
    state: present
    recreate: always
    pull: always
  become_user: "{{ app_user }}"
  register: output
  tags: ['deploy', 'start']

- name: Debug Docker Output
  debug:
    var: output
  tags: ['deploy', 'debug']

- name: Run database migrations
  docker_compose:
    project_src: "{{ app_directory }}/infraestructura/docker"
    services: app
    run: php artisan migrate --force
  become_user: "{{ app_user }}"
  tags: ['deploy', 'migrate']

- name: Wait for application to be ready
  wait_for:
    port: "{{ app_port }}"
    host: "{{ ansible_default_ipv4.address }}"
    delay: 10
    timeout: 300
  tags: ['deploy', 'wait']

- name: Setup log rotation
  template:
    src: laravel-api.logrotate.j2
    dest: /etc/logrotate.d/laravel-api
    owner: root
    group: root
    mode: '0644'
  tags: ['setup', 'logs']

- name: Setup firewall rules - SSH (Port 22)
  ufw:
    rule: allow
    port: "22"
    proto: tcp
  when: ansible_os_family == "Debian"
  tags: ['setup', 'firewall']

- name: Setup firewall rules - HTTP (Port 80)
  ufw:
    rule: allow
    port: "80"
    proto: tcp
  when: ansible_os_family == "Debian"
  tags: ['setup', 'firewall']

- name: Setup firewall rules - Application Port
  ufw:
    rule: allow
    port: "{{ app_port }}"
    proto: tcp
  when: ansible_os_family == "Debian"
  tags: ['setup', 'firewall']

- name: Enable UFW firewall
  ufw:
    state: enabled
    policy: deny
    direction: incoming
  when: ansible_os_family == "Debian"
  tags: ['setup', 'firewall']