name: Infrastructure Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ==========================================
  # Validate Ansible playbooks
  # ==========================================
  validate-ansible:
    name: ğŸ­ Validate Ansible
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Ansible
        run: |
          pip install ansible ansible-core ansible-lint
          ansible-galaxy install -r ansible/requirements.yml || true

      - name: ğŸ” Lint Ansible playbooks
        run: |
          cd ansible
          ansible-lint playbook.yml || true

      - name: âœ… Validate Ansible syntax
        run: |
          cd ansible
          ansible-playbook --syntax-check playbook.yml

      - name: ğŸ§ª Test Ansible inventory
        run: |
          cd ansible
          ansible-inventory --list -i inventory/hosts > /dev/null

  # ==========================================
  # Validate Docker configurations
  # ==========================================
  validate-docker:
    name: ğŸ³ Validate Docker
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Validate Docker Compose
        run: |
          docker-compose -f docker-compose.yml config > /dev/null
          docker-compose -f docker-compose.dev.yml config > /dev/null

  # ==========================================
  # Security scan
  # ==========================================
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ==========================================
  # Documentation check
  # ==========================================
  docs-check:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“ Check README exists
        run: |
          [ -f README.md ] || (echo "README.md is missing" && exit 1)

      - name: ğŸ” Validate markdown
        uses: DavidAnson/markdownlint-cli2-action@v13
        with:
          globs: '**/*.md'